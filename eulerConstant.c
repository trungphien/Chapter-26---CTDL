#include <stdlib.h>
#include <gmp.h>
#define mpq_for(buf, op, n)\
    do {\
        size_t i;\
        for (i = 0; i < (n); ++i)\
            mpq_##op(buf[i]);\
    } while (0)
#define N 10000
#define K 250
void bernoulli(mpq_t rop, unsigned int n)
{
    unsigned int m, j;
    mpq_t *a = malloc(sizeof(mpq_t) * (n + 1));
    mpq_for(a, init, n + 1);

    for (m = 0; m <= n; ++m) {
        mpq_set_ui(a[m], 1, m + 1);
        for (j = m; j > 0; --j) {
            mpq_sub(a[j-1], a[j], a[j-1]);
            mpq_set_ui(rop, j, 1);
            mpq_mul(a[j-1], a[j-1], rop);
        }
    }

    mpq_set(rop, a[0]);
    mpq_for(a, clear, n + 1);
    free(a);
}

int main(void)
{
    mpf_set_default_prec(5200);

    mpz_t n, d;
    mpq_t s, rop, tempq;
    mpf_t logaric, temp, tempf, x, y;

    mpz_inits(n, d, NULL);
    mpq_inits(s, rop, tempq, NULL);
    mpf_inits(logaric, temp, tempf, x,y, NULL);

    unsigned long int i;


	mpq_set_ui(s, 0, 1);
	for(i=1; i<N; i+=2)
	{
	    mpq_set_ui(tempq, 2*i+1, i*(i+1));
	    mpq_add(s, s, tempq);
	}

	mpf_set_str(logaric, "9.2103403719761827360719658187374568304044059545150919041333116038702904387094099209439888203583931933678711361691449945336381018603312270266651494763951267579316288333022187233751995793049327941135740212358615109305153846534648891507928795469861746698976169730974606201957372597575659184776176008884204068566992014752336050588322742270972864913420880459218654862636485493802991427790733854467168407225780282592001110010739666986202347427742693682682324545716898217623035702896832965258782756067035761027105245427677168133506348566640920422812358538288301761483389879760673077131233924737157259394099794579487711238705085103101588110674423809986866696733942817690028791860018859804201968859106270547754651907918088442873058198939090649702837717290331194010342039141061532830426905268657238023980351230094841332404791430189326165687233710175454367112468217239309929540182592076382441197167297272950101430839002158260750790041499883554768720820757358028954156820578536789061149147860443450285968795399914995495085382744836668233992313122390047754177800399125245876637386649642873867692404303937532767651689231700149891946037160395215677668106176672653429102228126063844542593861847635881712790534633479348653159286976294640366487114021671171054709245801671285506404440429241695913300875795952703916871946655772780957474236657884729870129825236501151133238544170519286121634982437110429065654191503064650517062731948198318196558196721968362777543231601310520717660124714674483696341517994450597339174194869498067032381483531242698097604235697799059187443004811028967274999575838865724220753927811533229867972712585397200012848013110626165218904875358823871778317738733728735812176593792148052230146970486147023192590818321256545511729451662405127413459938677690458608258397682916684774824097797174321480308759243894501328981934679540221131438647712203937887007940146667234998819879290928809792933723886764445472543536747861972948599877679187512120354016359184743950263195793457808481747928656611719512469718933303544316636500438687500437169939000957222906617851048036922751660725432", 10);

//caculate ln(N) use Taylors's series, thoi gian thuc thi ~ 55'( chinh xac den 1570 chu so thap phan)
/*
    mpf_set_ui(logaric, 0);
    mpf_set_ui(x, N-1);
    mpf_set_ui(y, N+1);
    mpf_div(tempf, x, y);
    for(i=1; i<200000000; i+=2)
    {
        mpf_pow_ui(temp, tempf, i);
        mpf_div_ui(temp, temp, i);
        mpf_add(logaric, logaric, temp);
    }
    mpf_mul_ui(logaric, logaric, 2);

    gmp_printf("ln(%u) =  %.Ff\n", N, logaric);
*/
    mpq_set_ui(tempq, 1, 2*N);
	mpq_sub(s, s, tempq);

    for (i = 2; i <= 2*K; i++) {
        bernoulli(rop, i);
        if (mpq_cmp_ui(rop, 0, 1))
        {
            mpf_set_ui(x, N);
            mpf_pow_ui(tempf, x, i);
            mpf_mul_ui(tempf, tempf, i);
            mpf_ui_div(tempf, 1, tempf);
            mpq_set_f(tempq, tempf);
            mpq_mul(tempq, rop, tempq);
            mpq_add(s, s, tempq);
        }
    }
    mpf_set_q(temp, s);
    mpf_sub(temp, temp, logaric);
    gmp_printf("Euler's Constant =  %.Ff\n", temp); // chinh xac den 1572 chu so, do chinh xac con tang khi thay doi so bit chinh xac

    mpz_clears(n, d, NULL);
    mpq_clears(s, rop, tempq, NULL);
    mpf_clears(logaric, temp, tempf, x, y, NULL);
    return 0;
}

